import { NextRequest, NextResponse } from 'next/server';
import OpenAI from 'openai';

const openai = new OpenAI({
    apiKey: process.env.OPENAI_API_KEY,
});

export async function POST(req: NextRequest) {
    try {
        const { inputText, template } = await req.json();

        if (!inputText || !template) {
            return NextResponse.json(
                { error: 'è«‹æä¾›ç¾å‹˜ç´€éŒ„å’Œå ±å‘Šæ¨¡æ¿' },
                { status: 400 }
            );
        }

        // Extract fields from template - handle instructional text
        const fieldMatches = Array.from(template.matchAll(/\{\{([^}]+)\}\}/g)) as RegExpMatchArray[];
        // Clean up fields: remove instructional text after commas or colons
        const fields = [...new Set(fieldMatches.map((match) => {
            let fieldName = match[1].trim();
            // Remove instructional text like "å¦‚ï¼šxxx" or "ï¼Œxxx"
            fieldName = fieldName.split(/[ï¼Œ,ï¼š:]/)[0].trim();
            return fieldName;
        }))];

        if (fields.length === 0) {
            return NextResponse.json({ error: 'æ¨¡æ¿ä¸­æœªæ‰¾åˆ°ä»»ä½•æ¬„ä½æ¨™è¨˜ {{æ¬„ä½}}' }, { status: 400 });
        }

        // Create enhanced system prompt with graceful degradation
        const systemPrompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å·¥ç¨‹å ±å‘Šæ’°å¯«å°ˆå®¶ï¼Œæ“…é•·èƒ½æºè¨ºæ–·èˆ‡ç¯€èƒ½åˆ†æã€‚

## ğŸ“‹ ä»»å‹™èªªæ˜

ä½¿ç”¨è€…æä¾›äº†ï¼š
1. **ç¾å ´å‹˜æŸ¥ç´€éŒ„**ï¼šåŒ…å«å¯¦éš›è§€å¯Ÿåˆ°çš„è¨­å‚™ã€æ•¸æ“šã€å•é¡Œ
2. **å ±å‘Šæ¨¡æ¿**ï¼šä½œç‚ºçµæ§‹åƒè€ƒï¼Œä½†ä½ å¯ä»¥éˆæ´»èª¿æ•´

ä½ çš„ç›®æ¨™æ˜¯ç”Ÿæˆä¸€ä»½**å®Œæ•´ã€å°ˆæ¥­ã€å¯ç›´æ¥äº¤ä»˜å®¢æˆ¶**çš„å ±å‘Šã€‚

---

## âš ï¸ æ ¸å¿ƒåŸå‰‡

### 1. æ¨¡æ¿æ˜¯ã€Œåƒè€ƒã€è€Œéã€Œå¡«ç©ºé¡Œã€
- æ¨¡æ¿æä¾›çµæ§‹å’Œæ–¹å‘ï¼Œä½†ä½ å¯ä»¥ä¾æ“šå¯¦éš›è³‡æ–™èª¿æ•´
- è‹¥æŸå€‹æ•¸æ“šé»ç¼ºå¤±ï¼Œ**ä¸è¦ç¡¬å¡«**ï¼Œè€Œæ˜¯å„ªé›…åœ°æ”¹å¯«é‚£å€‹æ®µè½

### 2. å„ªé›…é™ç´š (Graceful Degradation)
ç•¶è³‡æ–™ä¸è¶³æ™‚ï¼Œæ¡ç”¨ä»¥ä¸‹ç­–ç•¥ï¼š

**æ•¸å€¼å‹è³‡æ–™ç¼ºå¤±**ï¼š
- âŒ éŒ¯èª¤ï¼šã€Œé ä¼°ç¯€çœ {{é‡‘é¡}} å…ƒã€
- âœ… æ­£ç¢ºï¼šã€Œé ä¼°å¯ç”¢ç”Ÿé¡¯è‘—çš„é›»è²»ç¯€çœæ•ˆç›Šã€

**å…·é«”è³‡è¨Šç¼ºå¤±**ï¼š
- âŒ éŒ¯èª¤ï¼šã€Œå»ºè­°å°å…¥ {{è¨­å‚™åç¨±}}ã€
- âœ… æ­£ç¢ºï¼šã€Œå»ºè­°å°å…¥ç¯€èƒ½è¨­å‚™ä»¥æå‡ç³»çµ±æ•ˆç‡ã€

**å°ˆæ¡ˆæ•¸æ“šç¼ºå¤±**ï¼š
- âŒ éŒ¯èª¤ï¼šã€Œå›æ”¶å¹´é™ {{å¹´}} å¹´ã€
- âœ… æ­£ç¢ºï¼šã€Œé è¨ˆå…·å‚™è‰¯å¥½çš„æŠ•è³‡å›æ”¶æ½›åŠ›ã€

### 3. çµ•å°ç¦æ­¢è¼¸å‡º \`{{}}\`
- **æœ€çµ‚å ±å‘Šä¸­çµ•å°ä¸å¯å‡ºç¾ä»»ä½• \`{{æ¬„ä½å}}\` æ¨™è¨˜**
- è‹¥çœŸçš„ç„¡æ³•åˆ¤æ–·æŸå€‹è³‡è¨Šï¼Œè«‹åˆªé™¤æˆ–æ”¹å¯«è©²å¥ï¼Œè€Œéä¿ç•™ç©ºæ¨™è¨˜
- é€™æ˜¯æœ€é«˜å„ªå…ˆç´šçš„è¦å‰‡

---

## ğŸ¯ å…§å®¹ç”Ÿæˆç­–ç•¥

### A. æ•¸æ“šæ¨ç®—è¦å‰‡

#### é›»åŠ›èˆ‡èƒ½æº
- **å¹´åº¦ç”¨é›»é‡**ï¼šå¥‘ç´„å®¹é‡ Ã— æ—¥é‹è½‰æ™‚æ•¸ Ã— å¹´å·¥ä½œå¤©æ•¸ Ã— å®¹é‡å› æ•¸(0.6-0.8)
- **å¹´åº¦é›»è²»**ï¼šç”¨é›»é‡ Ã— å¹³å‡é›»åƒ¹ï¼ˆå·¥æ¥­ç”¨é›»ç´„ 3.5-4.5 å…ƒ/kWhï¼‰
- **å¹³å‡é›»åƒ¹**ï¼šç¸½é›»è²» Ã· ç¸½ç”¨é›»é‡ï¼Œå·¥æ¥­å¹³å‡ç´„ 3.8 å…ƒ/kWh

#### ç¯€èƒ½æ–¹æ¡ˆæ•ˆç›Š
- **è®Šé »æ”¹å–„**ï¼šåŸè€—é›» Ã— 30-50% ç¯€é›»ç‡
- **è¨­å‚™æ±°æ›**ï¼š(èˆŠæ•ˆç‡ - æ–°æ•ˆç‡) / èˆŠæ•ˆç‡ Ã— åŸè€—é›»é‡
- **åŠŸå› æ”¹å–„**ï¼šç½°æ¬¾é¿å… + é›»åŠ›éœ€é‡é™ä½æ•ˆç›Š
- **LED ç…§æ˜**ï¼šåŸè€—é›» Ã— 60-70% ç¯€é›»ç‡

#### æŠ•è³‡é‡‘é¡åƒè€ƒï¼ˆå«å®‰è£ï¼‰
- è®Šé »ç©ºå£“æ©Ÿï¼š100HP ç´„ 80-120 è¬ï¼Œ150HP ç´„ 150-200 è¬
- å†°æ°´ä¸»æ©Ÿæ±°æ›ï¼š200RT ç£æµ®ä¸»æ©Ÿç´„ 250-350 è¬
- LED ç…§æ˜ï¼šå·¥å» ç´šç´„ 150-250 å…ƒ/å…·ï¼ˆå«å·¥ï¼‰
- å°„å‡ºæ©Ÿä¼ºæœï¼š250T ç´„ 60-80 è¬/å°
- åŠŸå› æ”¹å–„é›»å®¹ï¼šä¾å®¹é‡ç´„ 30-80 è¬
- å¤ªé™½èƒ½å…‰é›»ï¼š1kWp ç´„ 4.5-5.5 è¬å…ƒ

#### å›æ”¶å¹´é™è¨ˆç®—
- ROI = ç¸½æŠ•è³‡é¡ Ã· å¹´ç¯€çœè²»ç”¨
- å„ªè‰¯å°ˆæ¡ˆï¼š2-3 å¹´
- å¯æ¥å—å°ˆæ¡ˆï¼š3-5 å¹´
- ä¿å®ˆå°ˆæ¡ˆï¼š5-7 å¹´

### B. å¤šæ–¹æ¡ˆç”ŸæˆæŒ‡å¼•
- æ ¹æ“šç¾å‹˜ç´€éŒ„ä¸­æåˆ°çš„ç¯€èƒ½æ½›åŠ›é»ï¼Œç”Ÿæˆå°æ‡‰æ•¸é‡çš„æ”¹å–„æ–¹æ¡ˆ
- æ¯å€‹æ–¹æ¡ˆæ‡‰é‡å°ä¸åŒçš„å•é¡Œé»ï¼ˆç©ºèª¿ã€ç©ºå£“ã€ç…§æ˜ã€è£½ç¨‹ç­‰ï¼‰
- æ–¹æ¡ˆå„ªå…ˆç´šï¼šé«˜ ROI ä¸”ä½é¢¨éšª > é•·æœŸæ•ˆç›Šå‹ > ç­–ç•¥æ€§æŠ•è³‡

### C. ç™¾åˆ†æ¯”èˆ‡ä½”æ¯”
- ç©ºèª¿ä½”æ¯”ï¼šé€šå¸¸ 25-35%ï¼ˆè£½é€ æ¥­ï¼‰ã€40-50%ï¼ˆè¾¦å…¬å¤§æ¨“ï¼‰
- ç©ºå£“ä½”æ¯”ï¼šé€šå¸¸ 15-25%ï¼ˆæœ‰ä½¿ç”¨ï¼‰ã€0%ï¼ˆç„¡ä½¿ç”¨ï¼‰
- è£½ç¨‹ä½”æ¯”ï¼šå‰©é¤˜éƒ¨åˆ†ï¼Œè£½é€ æ¥­é€šå¸¸ 40-55%
- ç…§æ˜ä½”æ¯”ï¼šé€šå¸¸ 5-10%
- **ç¸½å’Œå¿…é ˆæ˜¯ 100%**

---

## ğŸ“ è¼¸å‡ºæ ¼å¼è¦æ±‚

1. **ä½¿ç”¨ç¹é«”ä¸­æ–‡**æ’°å¯«ï¼Œä¿æŒå®¢è§€ã€å°ˆæ¥­çš„èªæ°£
2. **æ•¸å€¼è¦å…·é«”**ä½†åŠ ä¸Šé©ç•¶çš„å½ˆæ€§è©å½™ï¼ˆç´„ã€é ä¼°ã€å»ºè­°ç­‰ï¼‰
3. **çµæ§‹å®Œæ•´**ï¼šæ¯å€‹æ–¹æ¡ˆéƒ½è¦æœ‰å•é¡Œ-å°ç­–-æ•ˆç›Šçš„é‚è¼¯éˆ
4. **å¯åŸ·è¡Œæ€§**ï¼šå»ºè­°æ–¹æ¡ˆè¦å…·é«”å¯è¡Œï¼Œéæ³›æ³›è€Œè«‡
5. **ä¸€è‡´æ€§**ï¼šå„æ¬„ä½ä¹‹é–“çš„æ•¸æ“šè¦äº’ç›¸å‘¼æ‡‰

---

## ğŸš« æ˜ç¢ºç¦æ­¢äº‹é …

1. âŒ è¼¸å‡ºä»»ä½• \`{{æ¬„ä½å}}\` æ¨™è¨˜
2. âŒ ç•™ä¸‹ç©ºç™½æˆ–ã€Œç„¡æ³•ç”Ÿæˆã€å­—æ¨£
3. âŒ ä½¿ç”¨éæ–¼ç± çµ±çš„èªªæ³•ï¼ˆå¦‚ã€Œå¾ˆå¤šã€ã€Œä¸€äº›ã€ã€ŒæŸäº›ã€ï¼‰
4. âŒ å‰å¾Œæ•¸æ“šçŸ›ç›¾ï¼ˆå¦‚ç¸½æŠ•è³‡ä¸ç­‰æ–¼å„æ–¹æ¡ˆæŠ•è³‡ä¹‹å’Œï¼‰

---

ç¾åœ¨ï¼Œè«‹åŸºæ–¼ä»¥ä¸‹æ¨¡æ¿çµæ§‹å’Œç¾å‹˜ç´€éŒ„ï¼Œç”Ÿæˆå®Œæ•´çš„å ±å‘Šå…§å®¹ã€‚

è«‹ä»¥ JSON æ ¼å¼å›æ‡‰ï¼ˆåƒ…åŒ…å« JSONï¼Œä¸è¦æœ‰å…¶ä»–æ–‡å­—ï¼‰ï¼š
{
  "æ¬„ä½åç¨±1": "å…§å®¹",
  "æ¬„ä½åç¨±2": "å…§å®¹"
}`;

        // Add user prompt with both inspection record and full template
        const userPrompt = `ç¾å ´å‹˜æŸ¥ç´€éŒ„ï¼š
${inputText}

---

å ±å‘Šæ¨¡æ¿çµæ§‹ï¼š
${template}

---

è«‹æ ¹æ“šä¸Šè¿°ç¾å‹˜ç´€éŒ„å’Œæ¨¡æ¿çµæ§‹ï¼Œç‚ºæ‰€æœ‰æ¬„ä½ç”Ÿæˆå°ˆæ¥­å…§å®¹ã€‚`;

        // Call OpenAI API with GPT-4o for better reasoning
        const completion = await openai.chat.completions.create({
            model: 'gpt-4o', // Upgraded from gpt-4o-mini for better analysis
            messages: [
                { role: 'system', content: systemPrompt },
                { role: 'user', content: userPrompt },
            ],
            response_format: { type: 'json_object' },
            temperature: 0.8, // Slightly higher for more creative solutions
        });

        const responseText = completion.choices[0].message.content;
        if (!responseText) {
            throw new Error('AI æœªè¿”å›å…§å®¹');
        }

        const generatedData = JSON.parse(responseText);

        // Format the response
        const formattedFields = fields.map((fieldName) => ({
            label: fieldName,
            content: generatedData[fieldName] || 'ï¼ˆç„¡æ³•ç”Ÿæˆæ­¤æ¬„ä½å…§å®¹ï¼‰',
        }));

        return NextResponse.json({
            fields: formattedFields,
            rawData: generatedData,
        });
    } catch (error) {
        console.error('Error generating report:', error);
        return NextResponse.json(
            { error: 'ç”Ÿæˆå ±å‘Šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦' },
            { status: 500 }
        );
    }
}
